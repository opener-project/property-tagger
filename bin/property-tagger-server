#!/usr/bin/env ruby

require 'puma/cli'
require 'optparse'
require 'opener/core/resource_switcher'

# Puma sadly does not provide a system that allows us to cleanly inject custom
# options into their CLI. At the same time Puma doesn't provide an easy system
# of starting it *without* using the `Puma::CLI` class.
#
# To work around these problems we create our own parser and ignore any invalid
# option errors it throws up. This parser is used to handle options for the
# resource switcher.

rack_config   = File.expand_path('../../config.ru', __FILE__)
switcher      = Opener::Core::ResourceSwitcher.new
switcher_opts = {}

parser = OptionParser.new do |opts|
  opts.banner = "Usage: #{File.basename($0)} [OPTIONS]"

  opts.separator "\nOptions:\n"

  # Don't abort in this block as we otherwise can't show Puma's help message.
  opts.on('-h', '--help', 'Shows this help message') do
    puts parser
    puts
  end

  switcher.bind(opts, switcher_opts)

  opts.separator "\nPuma Usage:\n"
end

begin
  # Don't use parse! since that messes up Puma.
  parser.parse(ARGV)
rescue OptionParser::InvalidOption
  # Catch errors generated by Puma options and ignore them.
end

switcher.install(switcher_opts)

Puma::CLI.new([rack_config] + ARGV).run
